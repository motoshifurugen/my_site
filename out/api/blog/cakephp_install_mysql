{"slug":"cakephp_install_mysql","title":"CakePHP3.9にMySQLを接続する（Homebrew使用）","date":"2020-10-11","tags":["PHP","環境構築","MySQL"],"content":"\n### 環境\n\nOS：MacOS Catalina 10.15.4\nPHP：7.3.22\nComposer：1.10.13\nHomebrew：2.5.5\nMySQL：8.0.21\n\n- 前回の記事：[CakePHP3.9をMacにインストールする（MAMP使用）](https://qiita.com/motoshi_cocoa/items/6b2c3065e23d1bd05be5)\n\n以下のようにデータベース設定が未完了。今回はCakePHPでMySQLに接続するのが目的。\n![データベース接続前のCakePHPの画面](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/594194/b7069ac5-b646-dcc6-3495-fad05a6ad1e9.png)\n\n### この記事の流れ\n\n1. MySQLをインストール・起動\n\n1. エラーが出た（エラーなしなら飛ばす）\n\n1. MySQL初期設定\n\n1. CakePHPのデータベース設定\n\n1. CakePHP起動\n\n## 1. MySQLをインストール・起動\n\nパッケージ管理ツールHomebrewを使用してMysqlをインストールする。\n参考記事▼\n[【簡単】MacにHomebrewをインストールする方法と基本的な使い方](https://fukatsu.tech/homebrew)\n\n```bash:ターミナル\n$ brew install mysql\n```\n\n```bash:ターミナル\n$ mysql --version\nmysql  Ver 8.0.21 for osx10.15 on x86_64 (Homebrew)\n```\n\nインストールされたらCakePHPのアプリまで移動してからMySQLを起動。\n\n```bash:ターミナル\n$ mysql.server start\n```\n\n## 2. エラーが出た（エラーなしなら飛ばす）\n\nMySQLを起動しようとしたらエラーが出たので、手当たり次第ボタンがあれば連打した。\n\n▼エラー内容\n\n```bash:ターミナル\n./usr/local/Cellar/mysql/8.0.21_1/bin/mysqld_safe: line 144: /usr/local/var/mysql/[コンピュータ名].local.err: Permission denied\n/usr/local/Cellar/mysql/8.0.21_1/bin/mysqld_safe: line 144: /usr/local/var/mysql/[コンピュータ名].local.err: Permission denied\n/usr/local/Cellar/mysql/8.0.21_1/bin/mysqld_safe: line 199: /usr/local/var/mysql/[コンピュータ名].local.err: Permission denied\n/usr/local/Cellar/mysql/8.0.21_1/bin/mysqld_safe: line 144: /usr/local/var/mysql/[コンピュータ名].local.err: Permission denied\nERROR! The server quit without updating PID file (/usr/local/var/mysql/[コンピュータ名].local.pid).\n```\n\n- 権限がない\n  → sudoコマンドで実行する。\n\n- PIDファイルが .... ?\n  → このエラー文は様々な要因が考えられるらしい。\n  → そもそもファイルがなかったので作成。\n\n```bash:ターミナル\n$ sudo touch /usr/local/var/mysql/[コンピュータ名].local.pid\n```\n\nそれでもエラーは消えなかった。\n\n/usr/local/var/mysql/[コンピュータ名].local.err という場所に詳しいエラーが書いてあるらしいので確認しにいく。\n\n```bash:ターミナル\n$ sudo cat /usr/local/var/mysql/[コンピュータ名].local.err\n```\n\n[ERROR]となっているところを発見！\n\n```bash:ターミナル\n2020-10-10T16:38:01.565742Z 0 [ERROR] [MY-010274] [Server] Could not open unix socket lock file /tmp/mysql.sock.lock.\n2020-10-10T16:38:01.566306Z 0 [ERROR] [MY-010268] [Server] Unable to setup unix socket lock file.\n2020-10-10T16:38:01.567056Z 0 [ERROR] [MY-010119] [Server] Aborting\n```\n\n/tmp/mysql.sock.lockファイルにいなくなってもらう。\n\n```bash:ターミナル\n$ sudo rm /tmp/mysql.sock.lock\n```\n\nいざ、（sudoで）MySQL起動！\n\n```bash:ターミナル\n$ sudo mysql.server start\nStarting MySQL\n.. SUCCESS!\n```\n\n## 3. MySQL初期設定\n\nパスワードなしでMySQLにログインする。\n\n```bash:ターミナル\n$ mysql -uroot\n```\n\n- パスワード設定\n\n使うデータベースを指定して\n\n```bash:ターミナル\nmysql> use mysql;\n```\n\nrootユーザーのパスワードを [設定したいパスワード] に変更する。\n\n```bash:ターミナル\nmysql> ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '[設定したいパスワード]';\n```\n\n一旦、退出。\n\n```bash:ターミナル\nmysql> exit\n```\n\nパスワード使用でログインする。\n\n```bash:ターミナル\n$ mysql -uroot -p\nEnter password: [設定したパスワード]\n```\n\n## 4. CakePHPのデータベース設定\n\n- データベース作成\n\nMySQLでデータベース一覧を確認する。\n\n```bash:ターミナル\nmysql> show databases;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| mysql              |\n| performance_schema |\n| sys                |\n+--------------------+\n```\n\nCakePHPで使用するデータベースを新規で作成する。（今回はcake_sampleという名前で作成）\n\n```bash:ターミナル\nmysql> create database cake_sample;\n```\n\n先ほど作成したデータベースを一覧で確認する。\n\n```bash:ターミナル\nmysql> show databases;\n+--------------------+\n| Database           |\n+--------------------+\n| cake_sample        |\n| information_schema |\n| mysql              |\n| performance_schema |\n| sys                |\n+--------------------+\n```\n\nMySQLは設定完了。\n\n```bash:ターミナル\nmysql> exit\n```\n\n- CakePHPのデータベース設定\n\nCakePHPアプリの config/app.local.php をテキストエディタで開き、username, password, databaseを変更する。\n\n```php:/config/app.local.php（変更後）\n    'Datasources' => [\n        'default' => [\n            'host' => 'localhost',\n            'username' => 'root', //変更\n            'password' => '[設定したパスワード]', //変更\n            'database' => 'cake_sample', //変更\n            'log' => true,\n            'url' => env('DATABASE_URL', null),\n        ],\n    ],\n```\n\nmysqlを再起動させる。\n\n```bash:ターミナル\n$ sudo mysql.serve restart\nShutting down MySQL\n.. SUCCESS!\nStarting MySQL\n. SUCCESS!\n```\n\n## 5. CakePHP起動\n\n```bash:ターミナル\n$ bin/cake server\n```\n\nブラウザで `http://localhost:8765/` にアクセスして以下のようにdatabaseのアイコンが緑色になれば成功！\n![データベース接続完了後のCakePHPの画面](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/594194/4183987c-0420-33f5-4065-d1e207f7b8a4.png)\n\nここまで。\n\n接続はできたけど、毎回sudo使うことになったり、そもそも[Homebrewでsudoは使ってはいけないという情報](https://teratail.com/questions/263973)を発見。課題。\n\n### 参考記事\n\n- データベース設定について：[MySQL8.0 認証方式を変更する(Laravel5)](https://qiita.com/ucan-lab/items/3ae911b7e13287a5b917)\n\n- MySQLエラーについて：[MySQL5.7が起動できない。](https://qiita.com/gaogaomango/items/933a1f55004920a4323d)\n\nありがとうございました。\n"}